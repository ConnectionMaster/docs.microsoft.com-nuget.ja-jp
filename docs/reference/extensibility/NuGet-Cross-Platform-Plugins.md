---
title: クロス プラットフォームのプラグインの NuGet
description: NuGet.exe、dotnet.exe、msbuild.exe および Visual Studio の NuGet がプラットフォームのプラグインをクロスします。
author: nkolev92
ms.author: nikolev
ms.date: 07/01/2018
ms.topic: conceptual
ms.openlocfilehash: fdefc5b6189051fd83b2de644080284c09dd85f4
ms.sourcegitcommit: 1d1406764c6af5fb7801d462e0c4afc9092fa569
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/04/2018
ms.locfileid: "43548207"
---
# <a name="nuget-cross-platform-plugins"></a>クロス プラットフォームのプラグインの NuGet

NuGet 4.8 + でのクロス プラットフォームのプラグインのサポートが追加されました。
これは、厳密な一連の操作の規則に準拠する必要がありますが、新しいプラグイン拡張モデルを構築することによりで実現されました。
プラグインは、自己完結型の実行可能ファイル (実行可能コードを .NET Core の世界で)、NuGet クライアントを別のプロセスで起動します。
これは、変更は、true 書き込み 1 回、プラグインをすべての場所で実行します。 すべての NuGet クライアント ツールで動作します。
プラグインには、(NuGet.exe、MSBuild.exe と Visual Studio) での .NET Framework または .NET Core (dotnet.exe) のいずれかを指定できます。
NuGet クライアントと、プラグインのバージョン管理された通信プロトコルが定義されます。 スタートアップのハンドシェイク中には、2 つのプロセスは、プロトコルのバージョンをネゴシエートします。

NuGet クライアント ツールのすべてのシナリオを網羅するために .NET Framework と .NET Core のプラグインの両方に 1 つなります。
プラグインのクライアント/フレームワークの組み合わせを以下に示します。

| クライアント ツール  | フレームワーク |
| ------------ | --------- |
| Visual Studio | .NET Framework |
| dotnet.exe | .NET Core |
| NuGet.exe | .NET Framework |
| MSBuild.exe | .NET Framework |
| Mono 上で NuGet.exe | .NET Framework |

## <a name="how-does-it-work"></a>しくみ

高レベルのワークフローは、次のように記述できます。

1. NuGet では、使用可能なプラグインを検出します。
1. 該当する場合、NuGet は優先順位で 1 つずつ開始プラグインを反復処理します。
1. NuGet では、要求を処理できる最初のプラグインを使用します。
1. プラグインは不要になったとき、シャット ダウンをされます。

## <a name="general-plugin-requirements"></a>一般的なプラグインの要件

現在のプロトコルのバージョンは*2.0.0*します。
このバージョンは、下の要件は次のとおりです。

- 信頼された有効な Authenticode 署名のアセンブリがある Windows、Mono で実行されます。 Linux および Mac でまだ実行アセンブリの信頼の特別な要件はありません。 [関連する問題](https://github.com/NuGet/Home/issues/6702)
- NuGet クライアント ツールの現在のセキュリティ コンテキストでステートレスな起動をサポートします。 たとえば、昇格または後で説明されているプラグインのプロトコルの外部で追加の初期化、NuGet クライアント ツールは実行されません。
- 明示的に指定しない限り、非対話形式にします。
- プラグインのネゴシエートされたプロトコルのバージョンに準拠します。
- 妥当な時間内のすべての要求に応答します。
- 任意の実行中の操作の取り消し要求が受け入れられます。

技術仕様は次の仕様で詳しく説明します。

- [NuGet パッケージのダウンロードのプラグイン](https://github.com/NuGet/Home/wiki/NuGet-Package-Download-Plugin)
- [フォーム認証のプラグイン相互の NuGet](https://github.com/NuGet/Home/wiki/NuGet-cross-plat-authentication-plugin)

## <a name="client---plugin-interaction"></a>クライアントのプラグイン相互作用

NuGet クライアント ツールとプラグインは、標準ストリーム (stdin、stdout、stderr) 経由での JSON で通信します。 すべてのデータは utf-8 エンコードである必要があります。
プラグインは、引数で起動されます"-プラグイン"されます。 場合に、ユーザーは、この引数を指定せずに実行可能なプラグインを直接起動、プラグインは、プロトコルのハンドシェイクを待つのではなく、情報メッセージを与えることができます。
プロトコルのハンドシェイクのタイムアウトは、5 秒です。 プラグインには、可能な容量が不足としてのセットアップを完了する必要があります。
NuGet クライアント ツールは、NuGet ソースのサービス インデックスを渡すことで、プラグインのサポートされている操作を照会します。 プラグインでは、サービスのインデックスを使用して、サポートされているサービスの種類の存在を確認してください。

NuGet クライアント ツールとプラグイン間の通信は、双方向です。 各要求では、5 秒のタイムアウトがあります。 操作に長い時間がかかることになっている場合、対応するプロセスが要求をタイムアウトにならないようにする進行状況メッセージを送信する必要があります。1 分続いた後に、プラグインはアイドル状態と見なされがシャット ダウンします。

## <a name="plugin-installation-and-discovery"></a>プラグインのインストールと探索

規約ベースのディレクトリ構造を使用して、プラグインが検出されます。
CI/CD のシナリオおよびパワー ユーザーは、動作をオーバーライドするのに環境変数を使用することができます。

- `NUGET_PLUGIN_PATHS` -予約済みの優先度、その NuGet プロセスに使用される、プラグインを定義します。 この環境変数が設定されている場合は、規則ベースの検出を上書きします。
-  ユーザーの場所の NuGet のホーム場所、`%UserProfile%/.nuget/plugins`します。 この場所は、オーバーライドにすることはできません。 別のルート ディレクトリは、.NET Core と .NET Framework のプラグインに使用されます。

| フレームワーク | ルートの検出場所  |
| ------- | ------------------------ |
| .NET Core |  `%UserProfile%/.nuget/plugins/netcore` |
| .NET Framework | `%UserProfile%/.nuget/plugins/netfx` |

各プラグインは、独自のフォルダーにインストールする必要があります。
プラグインのエントリ ポイントは、.NET Core の .dll 拡張子と .NET Framework の拡張子が .exe と、インストールされているフォルダーの名前になります。

```
.nuget
    plugins
        netfx
            myPlugin
                myPlugin.exe
                nuget.protocol.dll
                ...
        netcore
            myPlugin
                myPlugin.dll
                nuget.protocol.dll
                ...
```

> [!Note]
> 現在、プラグインをインストールするためのユーザー ストーリーはありません。 必要なファイルを事前に定義された場所に移動するだけになります。

## <a name="supported-operations"></a>サポートされる操作

新しいプラグインのプロトコルの下では、2 つの操作がサポートされています。

| 操作名 | 最小バージョンのプロトコル | 最小の NuGet クライアント バージョン |
| -------------- | ----------------------- | --------------------- |
| パッケージをダウンロードします。 | 1.0.0 | 4.3.0 |
| [認証](NuGet-Cross-Platform-Authentication-Plugin.md) | 2.0.0 | 4.8.0 |

## <a name="running-plugins-under-the-correct-runtime"></a>適切なランタイムでプラグインを実行しています。

Dotnet.exe のシナリオでは、NuGet のプラグインは、dotnet.exe の特定のランタイムで実行できる必要があります。
互換性のある dotnet.exe/plugin 組み合わせが使用されているかどうかを確認するには、プラグインのプロバイダーとコンシューマーになります。
ユーザー場所プラグインと、たとえばで潜在的な問題が発生する可能性が、2.0 ランタイムの下の dotnet.exe 2.1 ランタイム用に記述されたプラグインを使用しようとします。

## <a name="capabilities-caching"></a>キャッシュ機能

セキュリティ検証と、プラグインのインスタンス化は、コストのかかるのです。 ダウンロード操作は、平均の NuGet ユーザーの認証プラグインをされている可能性がのみ認証の操作よりもずっと多く頻繁に発生します。
エクスペリエンスを向上させるのには、NuGet は指定された要求の操作要求をキャッシュします。 このキャッシュは、プラグインのパスをされているプラグインのキーを持つプラグインごと、および、この機能のキャッシュの有効期限は 30 日間。 

キャッシュにある`%LocalAppData%/NuGet/plugins-cache`環境変数でオーバーライドされると`NUGET_PLUGINS_CACHE_PATH`します。 これをオフにする[キャッシュ](../../consume-packages/managing-the-global-packages-and-cache-folders.md)、ローカル変数に 1 つ実行コマンドを`plugins-cache`オプション。
`all` [ローカル] オプションは、プラグインのキャッシュも削除されますようになりました。 

## <a name="protocol-messages-index"></a>プロトコル メッセージのインデックス

プロトコル バージョン*1.0.0*メッセージ。

1.  閉じる
    * 方向の要求: NuGet プラグインを ->
    * 要求にペイロードが含まれません
    * 応答は発生しません。  適切な応答は、プラグイン プロセスがすぐに終了するからです。

2.  パッケージ ファイルをコピーします。
    * 方向の要求: NuGet プラグインを ->
    * 要求が含まれます。
        * パッケージ ID とバージョン
        * パッケージ ソースのリポジトリ場所
        * ターゲット ディレクトリのパス
        * デプロイ先のディレクトリ パスにコピーするパッケージ内のファイルの列挙型
    * 応答が含まれます。
        * 操作の結果を示す応答コード
        * 操作が成功した場合は、保存先ディレクトリにコピーしたファイルの完全なパスの列挙型

3.  パッケージ ファイルのコピー (.nupkg)
    * 方向の要求: NuGet プラグインを ->
    * 要求が含まれます。
        * パッケージ ID とバージョン
        * パッケージ ソースのリポジトリ場所
        * コピー先のファイル パス
    * 応答が含まれます。
        * 操作の結果を示す応答コード

4.  資格情報を取得します。
    * 方向の要求: プラグインは NuGet を ->
    * 要求が含まれます。
        * パッケージ ソースのリポジトリ場所
        * 現在の資格情報を使用して、パッケージのソース リポジトリから取得した HTTP 状態コード
    * 応答が含まれます。
        * 操作の結果を示す応答コード
        * 使用可能な場合、ユーザー名
        * 使用可能な場合、パスワード

5.  パッケージ内のファイルを取得します。
    * 方向の要求: NuGet プラグインを ->
    * 要求が含まれます。
        * パッケージ ID とバージョン
        * パッケージ ソースのリポジトリ場所
    * 応答が含まれます。
        * 操作の結果を示す応答コード
        * 操作が成功した場合、パッケージ内のファイル パスの列挙型

6.  操作の信頼性情報を取得します。 
    * 方向の要求: NuGet プラグインを ->
    * 要求が含まれます。
        * パッケージ ソースのサービス index.json
        * パッケージ ソースのリポジトリ場所
    * 応答が含まれます。
        * 操作の結果を示す応答コード
        * サポートされている操作の列挙型 (例:: パッケージのダウンロード)、操作が成功した場合。  プラグインがパッケージ ソースをサポートしていない場合、プラグインがサポートされている操作の空のセットを返す必要があります。

> [!Note]
> このメッセージがバージョンに更新された*2.0.0*します。 旧バージョンとの互換性を保つため、クライアントになります。

7.  パッケージ ハッシュを取得します。
    * 方向の要求: NuGet プラグインを ->
    * 要求が含まれます。
        * パッケージ ID とバージョン
        * パッケージ ソースのリポジトリ場所
        * ハッシュ アルゴリズム
    * 応答が含まれます。
        * 操作の結果を示す応答コード
        * 操作が成功した場合は、要求されたハッシュ アルゴリズムを使用してパッケージ ファイルのハッシュ

8.  パッケージのバージョンを取得します。
    * 方向の要求: NuGet プラグインを ->
    * 要求が含まれます。
        * パッケージ ID
        * パッケージ ソースのリポジトリ場所
    * 応答が含まれます。
        * 操作の結果を示す応答コード
        * 操作が成功した場合、パッケージのバージョンの列挙型

9.  サービス インデックスを取得します。
    * 方向の要求: プラグインは NuGet を ->
    * 要求が含まれます。
        * パッケージ ソースのリポジトリ場所
    * 応答が含まれます。
        * 操作の結果を示す応答コード
        * 操作が成功した場合のサービス インデックス

10.  ハンドシェイク
     * 方向の要求: NuGet <> - プラグイン
     * 要求が含まれます。
         * 現在のプラグインのプロトコルのバージョン
         * 最小のサポートされているプラグイン プロトコルのバージョン
     * 応答が含まれます。
         * 操作の結果を示す応答コード
         * 操作が成功した場合は、ネゴシエートされたプロトコル バージョン。  プラグインの終了エラーが発生します。

11.  初期化します。
     * 方向の要求: NuGet プラグインを ->
     * 要求が含まれます。
         * バージョンの NuGet クライアント ツール
         * NuGet クライアント ツールの有効な言語です。  これは、考慮 ForceEnglishOutput 設定、使用されている場合。
         * プロトコルの既定値よりも優先される既定の要求のタイムアウト。
     * 応答が含まれます。
         * 操作の結果を示す応答コードを返します。  プラグインの終了エラーが発生します。

12.  ログ
     * 方向の要求: プラグインは NuGet を ->
     * 要求が含まれます。
         * 要求のログ レベル
         * 記録するメッセージ
     * 応答が含まれます。
         * 操作の結果を示す応答コードを返します。

13.  NuGet のプロセスの終了時を監視します。
     * 方向の要求: NuGet プラグインを ->
     * 要求が含まれます。
         * NuGet のプロセス ID
     * 応答が含まれます。
         * 操作の結果を示す応答コードを返します。

14.  パッケージをプリフェッチします。
     * 方向の要求: NuGet プラグインを ->
     * 要求が含まれます。
         * パッケージ ID とバージョン
         * パッケージ ソースのリポジトリ場所
     * 応答が含まれます。
         * 操作の結果を示す応答コード

15.  資格情報の設定
     * 方向の要求: NuGet プラグインを ->
     * 要求が含まれます。
         * パッケージ ソースのリポジトリ場所
         * 最後既知のパッケージ ソース名、使用可能な場合
         * 最後既知のパッケージ ソース パスワード、使用可能な場合
         * 使用可能な場合は最後の既知のプロキシ名
         * 使用可能な場合は最後の既知のプロキシ パスワード
     * 応答が含まれます。
         * 操作の結果を示す応答コード

16.  ログ レベルの設定
     * 方向の要求: NuGet プラグインを ->
     * 要求が含まれます。
         * 既定のログ レベル
     * 応答が含まれます。
         * 操作の結果を示す応答コード

プロトコル バージョン*2.0.0*メッセージ

17. 操作の信頼性情報を取得します。

* 方向の要求: NuGet プラグインを ->
    * 要求が含まれます。
        * パッケージ ソースのサービス index.json
        * パッケージ ソースのリポジトリ場所
    * 応答が含まれます。
        * 操作の結果を示す応答コード
        * 操作が成功した場合、サポートされている操作の列挙型。  プラグインがパッケージ ソースをサポートしていない場合、プラグインがサポートされている操作の空のセットを返す必要があります。

    サービス インデックスとパッケージ ソースが null の場合、このプラグインは、認証で応答できます。

18. 認証の資格情報を取得します。

* 方向の要求: NuGet プラグインを ->
* 要求が含まれます。
    * URI
    * isRetry
    * NonInteractive
    * CanShowDialog
* 応答には
    * [ユーザー名]
    * [Password]
    * メッセージ
    * 認証の種類の一覧
    * MessageResponseCode